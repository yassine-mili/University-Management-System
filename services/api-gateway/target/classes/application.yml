server:
  port: 8080

spring:
  application:
    name: api-gateway

  # Redis Configuration
  data:
    redis:
      host: localhost
      port: 6379
      timeout: 2000ms

  cloud:
    gateway:
      # Global CORS Configuration
      globalcors:
        corsConfigurations:
          "[/**]":
            allowedOrigins:
              - "http://localhost:3000"
              - "http://localhost:4200"
              - "http://localhost:8080"
            allowedMethods:
              - GET
              - POST
              - PUT
              - DELETE
              - OPTIONS
              - PATCH
            allowedHeaders: "*"
            allowCredentials: true
            maxAge: 3600

      # Route Definitions
      routes:
        # Authentication Service (Spring Boot - Port 8081)
        - id: auth-service
          uri: http://localhost:8081
          predicates:
            - Path=/api/auth/**
          filters:
            - StripPrefix=2
            - name: CircuitBreaker
              args:
                name: authService
                fallbackUri: forward:/fallback/auth
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                redis-rate-limiter.requestedTokens: 1

        # Student Service (Node.js/Express - Port 8082)
        - id: student-service
          uri: http://localhost:8082
          predicates:
            - Path=/api/students/**
          filters:
            - StripPrefix=2
            - name: CircuitBreaker
              args:
                name: studentService
                fallbackUri: forward:/fallback/student
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                redis-rate-limiter.requestedTokens: 1

        # Courses Service (JAX-WS SOAP - Port 8083)
        - id: courses-service
          uri: http://localhost:8083
          predicates:
            - Path=/api/courses/**
          filters:
            - StripPrefix=2
            - name: CircuitBreaker
              args:
                name: coursesService
                fallbackUri: forward:/fallback/courses
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                redis-rate-limiter.requestedTokens: 1

        # Grades Service (Python FastAPI - Port 8084)
        - id: grades-service
          uri: http://localhost:8084
          predicates:
            - Path=/api/grades/**
          filters:
            - StripPrefix=2
            - name: CircuitBreaker
              args:
                name: gradesService
                fallbackUri: forward:/fallback/grades
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
                redis-rate-limiter.requestedTokens: 1

        # Billing Service (.NET Core SOAP - Port 5000)
        - id: billing-service
          uri: http://localhost:5000
          predicates:
            - Path=/api/billing/**
          filters:
            - StripPrefix=2
            - name: CircuitBreaker
              args:
                name: billingService
                fallbackUri: forward:/fallback/billing
            - name: RequestRateLimiter
              args:
                redis-rate-limiter.replenishRate: 5
                redis-rate-limiter.burstCapacity: 10
                redis-rate-limiter.requestedTokens: 1

# JWT Configuration (Must match auth-service)
jwt:
  secret: 404E635266556A586E3272357538782F413F4428472B4B6250645367566B5970
  expiration: 3600000 # 1 hour in milliseconds

# Resilience4j Circuit Breaker Configuration
resilience4j:
  circuitbreaker:
    instances:
      authService:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 3
      studentService:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 3
      coursesService:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 3
      gradesService:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 3
      billingService:
        slidingWindowSize: 10
        minimumNumberOfCalls: 5
        failureRateThreshold: 50
        waitDurationInOpenState: 10000
        permittedNumberOfCallsInHalfOpenState: 3

# Actuator for Monitoring
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway,circuitbreakers,ratelimiters
  endpoint:
    health:
      show-details: always
    gateway:
      enabled: true

# Logging
logging:
  level:
    root: INFO
    org.springframework.cloud.gateway: DEBUG
    com.universite.gateway: DEBUG
    io.github.resilience4j: DEBUG
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} - %msg%n"
